# 吉他效果器插件加载器 - 简化项目计划书

## 一、项目概述

### 1.1 项目背景
吉他手在日常练习中通常使用软件效果器配合声卡，但大多数专业插件（如 Neural DSP、Positive Grid 等）只能在 DAW 中运行。启动完整的 DAW（如 Logic Pro、Ableton Live）对于简单练琴来说过于繁重，占用资源多、启动慢、界面复杂。

### 1.2 项目目标
开发一个轻量化的 macOS 插件宿主（Plugin Host），专注于实时音频处理，提供：
- 低延迟的音频信号链（基于 CoreAudio）
- VST3 插件加载和串联处理
- 简洁的 UI 界面
- 极低的系统资源占用

### 1.3 目标用户
- macOS 平台的吉他/贝斯手
- 需要实时监听效果的音乐人
- 追求简洁体验的练琴者

### 1.4 项目范围限定
**包含功能**：
- ✅ macOS 平台（CoreAudio）
- ✅ VST3 插件支持
- ✅ 串联信号链（Serial Chain）
- ✅ 基础插件 UI 调用
- ✅ 简单的预设管理

**暂不包含**：
- ❌ Windows/Linux 支持
- ❌ AU (Audio Unit) 插件
- ❌ 参数自动化（Automation）
- ❌ 并联信号链（Parallel Chain）
- ❌ 旁链（Sidechain）
- ❌ MIDI 支持

---

## 二、核心功能需求

### 2.1 音频引擎（第一阶段：基础信号链）

#### 功能描述
实现一个完全 bypass 的音频信号链，验证基础架构的可行性。

#### 技术要点
- **音频驱动层**
  - macOS CoreAudio（通过 `cpal` 库）
  
- **音频参数**
  - 采样率: 44.1kHz, 48kHz（可配置，默认 48kHz）
  - 缓冲区大小: 128-512 samples（可调节，默认 256）
  - 位深度: 32-bit float
  - 通道: 立体声输入输出（L/R）

- **性能目标**
  - 总延迟 < 12ms（256 samples @ 48kHz）
  - CPU 占用 < 10%（空载状态）
  - 无音频爆音（buffer underruns）

#### 验收标准
- [ ] 能正确列举 macOS 系统中的音频设备
- [ ] 能选择输入/输出设备并建立音频流
- [ ] 输入信号能实时无损传递到输出（bit-perfect bypass）
- [ ] 能实时显示输入输出电平（峰值）
- [ ] 能稳定运行 1 小时以上无崩溃

---

### 2.2 插件管理系统（第二阶段：加载与处理）

#### 功能描述
实现 VST3 插件的扫描、加载、实例化和串联音频处理。

#### 技术要点
- **插件扫描**
  - 扫描 macOS VST3 标准目录：
    - `/Library/Audio/Plug-Ins/VST3`
    - `~/Library/Audio/Plug-Ins/VST3`
  - 建立插件数据库（JSON 缓存文件）
  - 识别插件基本信息（名称、厂商、输入输出配置）

- **插件加载**
  - 动态链接库加载（.vst3 bundle）
  - 插件实例化和生命周期管理
  - 插件状态保存/恢复（基础 preset）

- **音频处理集成**
  - 插件串联（Serial Chain，顺序处理）
  - 最多支持 8 个插件同时串联

- **使用的 Rust 库**
  - `vst3-sys`: VST3 SDK 的 Rust 绑定
  - `libloading`: 动态库加载

#### 验收标准
- [ ] 能扫描并列出所有已安装的 VST3 插件
- [ ] 能加载至少 3 个主流插件（Neural DSP、Amplitube 等）
- [ ] 插件能正确处理音频信号
- [ ] 能保存和加载插件参数状态
- [ ] 能构建包含 3-5 个插件的串联信号链
- [ ] 插件处理后音频质量无损（无爆音、失真）

---

### 2.3 用户界面（第三阶段：GUI 与交互）

#### 功能描述
提供简洁的图形界面，支持基础的插件管理和 UI 调用。

#### 技术要点
- **主窗口功能**
  - 音频设备选择器（下拉菜单）
  - 输入/输出电平表（简单的峰值显示）
  - 插件列表显示（垂直列表，顺序即信号链）
  - 添加/删除插件按钮
  - 简单的性能监控（CPU 占用）

- **插件窗口管理**
  - 调用插件原生 UI（VST3 Editor）
  - 点击插件列表项打开对应窗口
  - 基础的窗口显示/隐藏

- **UI 框架：egui**
  - 轻量级、immediate mode GUI
  - 易于集成 Rust 生态
  - 支持 macOS Retina 显示

#### 验收标准
- [ ] 主界面简洁清晰、响应流畅
- [ ] 能打开插件 UI 窗口
- [ ] 插件 UI 基本交互正常
- [ ] 能添加、删除、重新排序插件
- [ ] 能保存和加载工程文件（JSON 格式）

---

## 三、技术架构

### 3.1 技术栈：Rust

#### 选择 Rust 的理由
1. **内存安全** - 避免崩溃和内存泄漏（音频软件崩溃是灾难）
2. **性能优异** - 零成本抽象，接近 C/C++ 性能
3. **并发友好** - 安全的多线程模型，适合实时音频处理
4. **现代工具链** - Cargo 包管理，简化依赖和构建

#### 核心依赖库（Cargo.toml）

```toml
[dependencies]
# 音频 I/O
cpal = "0.15"                    # CoreAudio 封装

# VST3 插件支持
vst3-sys = "0.3"                 # VST3 SDK 绑定
libloading = "0.8"               # 动态库加载

# GUI
egui = "0.28"                    # UI 框架
eframe = "0.28"                  # egui 应用框架

# 工具库
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"               # 配置和预设序列化
log = "0.4"                      # 日志
env_logger = "0.11"              # 日志实现
anyhow = "1.0"                   # 错误处理
```

---

### 3.2 系统架构设计

```
┌─────────────────────────────────────────────────┐
│              用户界面层 (GUI)                    │
│           egui + eframe                         │
│  - 设备选择  - 插件列表  - 电平表  - 工程管理    │
└─────────────────┬───────────────────────────────┘
                  │ (消息传递)
┌─────────────────▼───────────────────────────────┐
│            应用逻辑层 (Application)              │
│  - 插件管理器  - 工程文件 I/O                    │
└─────────────────┬───────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────┐
│          音频引擎层 (Audio Engine)               │
│  - 串联信号链  - 插件处理  - 电平计算            │
└─────────────────┬───────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────┐
│            音频驱动层 (Audio I/O)                │
│              cpal (CoreAudio)                   │
└─────────────────────────────────────────────────┘
```

#### 关键模块说明

1. **AudioEngine (核心)**
   - 运行在独立的实时线程（CPAL 回调）
   - 使用 Rust 的 `Arc<Mutex<T>>` 或无锁队列通信
   - 处理音频回调函数（process 方法）
   
2. **PluginChain**
   - 管理插件列表（Vec<Plugin>）
   - 顺序调用每个插件的 process 方法
   - 处理插件的添加、删除、重排序

3. **ProjectManager**
   - 工程文件的序列化/反序列化（JSON）
   - 保存插件链配置和参数状态

---

## 四、开发路线图

### Phase 1: 基础音频引擎（1-2 周）

**任务清单**
- [ ] 创建 Rust 项目，配置 Cargo.toml
- [ ] 集成 CPAL，实现设备枚举
- [ ] 实现简单的 bypass 信号链
- [ ] 添加基础的电平计算
- [ ] 性能和稳定性测试

**交付物**：
- ✅ 能稳定运行的 bypass 音频引擎
- ✅ 命令行输出音频设备和电平

---

### Phase 2: VST3 插件系统（2-3 周）

**任务清单**
- [ ] 集成 vst3-sys，学习 VST3 API
- [ ] 实现插件扫描功能
- [ ] 实现单个插件加载和实例化
- [ ] 将插件集成到音频回调中
- [ ] 实现串联信号链（2-3 个插件）
- [ ] 插件状态保存/加载（JSON）

**交付物**：
- ✅ 能加载并运行 VST3 插件
- ✅ 支持 3-5 个插件串联

---

### Phase 3: 图形界面（2 周）

**任务清单**
- [ ] 集成 egui + eframe
- [ ] 实现主窗口布局（设备选择、插件列表、电平表）
- [ ] 实现插件添加/删除/排序功能
- [ ] 调用插件原生 UI（VST3 Editor）
- [ ] 实现工程文件保存/加载

**交付物**：
- ✅ 完整的 GUI 应用
- ✅ MVP 可用版本

---

### Phase 4: 优化与发布（1 周）

**任务清单**
- [ ] 性能优化和错误处理完善
- [ ] 用户测试和 bug 修复
- [ ] 编写 README 和基础文档
- [ ] 代码签名和 macOS 公证
- [ ] 打包成 .app 或 .dmg

**交付物**：
- ✅ 1.0 版本正式发布

---

## 五、技术难点与风险

### 5.1 主要技术挑战

| 难点 | 风险等级 | 解决方案 |
|------|---------|---------|
| VST3 API 复杂度 | 🟡 中 | 参考开源项目（vst-rs、nih-plug），逐步学习 |
| 音频线程安全 | 🟡 中 | 使用 Rust 的类型系统保证线程安全，避免音频线程中分配内存 |
| 插件 UI 调用 | 🟡 中 | 使用 Cocoa API 嵌入插件窗口 |
| 插件崩溃处理 | 🟢 低 | 初期容忍崩溃，后期考虑隔离机制 |

### 5.2 风险管理

**风险 1: VST3 API 学习曲线陡峭**
- **应对**: 先实现最简单的插件加载，参考现有 Rust VST3 项目

**风险 2: 插件兼容性问题**
- **应对**: 优先支持主流插件（Neural DSP、Amplitube），建立测试列表

**风险 3: 性能不达标**
- **应对**: 早期就进行性能测试，优化热点代码路径

---

## 六、成功指标

### 6.1 性能指标
- ✅ 总延迟 < 10ms（128 samples @ 48kHz）
- ✅ CPU 占用 < 30%（加载 3 个插件时）
- ✅ 内存占用 < 200MB（不含插件）
- ✅ 启动时间 < 3 秒

### 6.2 功能指标
- ✅ 支持 90% 以上主流 VST3 插件
- ✅ 支持至少 8 个插件的串联
- ✅ 零音频爆音（在正常缓冲区设置下）
- ✅ 连续运行 24 小时无崩溃

### 6.3 用户体验指标
- ✅ UI 响应时间 < 100ms
- ✅ 上手时间 < 10 分钟（新用户）
- ✅ 用户满意度 > 4.0/5.0

---

## 七、未来扩展方向

### 7.1 短期扩展（1-2 个版本）
- 支持 MIDI 设备输入（MIDI 控制器控制参数）
- 预设切换脚踏开关支持
- 简单的调音器功能
- 节拍器

### 7.2 中期扩展（3-6 个月）
- 录音功能（录制干信号和湿信号）
- 简单的多轨混音
- 内置基础效果器（EQ、Compressor、Reverb）
- 云端预设分享社区

### 7.3 长期愿景（1 年+）
- iOS/Android 版本（平板做控制面板）
- 硬件控制器集成
- AI 音色匹配（通过音频识别推荐插件链）
- 插件市场和推荐系统

---

## 八、资源需求


### 8.1 硬件需求
- macOS 设备（macOS 12+）
- 音频接口至少 1 个（volt1）

### 8.3 软件需求
- 开发工具: cursor
- 测试插件: Neural DSP, UAD 等
- 性能分析工具: Instruments (macOS) / Visual Studio Profiler

---

## 九、总结

这个项目具有很强的实用价值，目标用户明确，技术路线可行。建议：

1. **优先使用 Rust + CPAL**：兼顾性能和开发效率
2. **采用迭代开发**：每个 Phase 都产出可测试的版本
3. **尽早测试真实场景**：找几位吉他手用户体验
4. **关注社区**：参考 JUCE Forum、KVR Audio 等社区的经验

**关键成功因素**：
- ✨ 低延迟（这是核心竞争力）
- ✨ 稳定性（绝不能在练琴时崩溃）
- ✨ 简洁性（比 DAW 更轻量）

祝项目顺利！🎸

